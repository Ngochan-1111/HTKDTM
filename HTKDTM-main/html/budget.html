<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NgÃ¢n sÃ¡ch | Finance BI</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/budget.css">
</head>
<body>

<div class="container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ’¼ Finance BI</h1>
      <p class="user-email">ğŸ‘¤ <span id="userEmail">TÃ i khoáº£n</span></p>
      <button class="btn-logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
    </div>

    <nav class="sidebar-nav">
      <a href="index.html">ğŸ“Š Thu â€“ Chi</a>
      <a>ğŸ“ˆ Dashboard</a>
      <a class="active">ğŸ’° NgÃ¢n sÃ¡ch</a>
      <a>ğŸ” Insight</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <h2 class="title">ğŸ“Š Láº­p káº¿ hoáº¡ch ngÃ¢n sÃ¡ch</h2>

    <button class="add-budget-btn" onclick="openModal()">â• ThÃªm ngÃ¢n sÃ¡ch</button>

    <div id="budgetList" class="budget-list"></div>

    <!-- MODAL -->
    <div id="budgetModal" class="modal hidden">
      <div class="modal-content">
        <h3>â• ThÃªm ngÃ¢n sÃ¡ch</h3>

        <label>ThÃ¡ng</label>
        <select id="budgetMonth"></select>

        <label>NÄƒm</label>
        <select id="budgetYear"></select>

        <label>Danh má»¥c</label>
        <select id="categorySelect">
          <option value="Ä‚n uá»‘ng">Ä‚n uá»‘ng</option>
          <option value="NhÃ  á»Ÿ">NhÃ  á»Ÿ</option>
          <option value="Di chuyá»ƒn">Di chuyá»ƒn</option>
          <option value="Giáº£i trÃ­">Giáº£i trÃ­</option>
        </select>

        <label>Háº¡n má»©c (VND)</label>
        <input type="number" id="budgetLimit">

        <div class="modal-actions">
          <button type="button" onclick="saveBudget()">LÆ°u</button>
          <button type="button" class="cancel" onclick="closeModal()">Há»§y</button>
        </div>
      </div>
    </div>

    <!-- FORM POST GIá»NG THUâ€“CHI -->
    <form
    id="budgetForm"
    action="https://script.google.com/macros/s/AKfycbx4OM__SN-pnUFUFhRHmzHFUFKSwXwsEx6KR1PpRKcUG9vo4OfvxyMmjybEgfuH1h4eKA/exec"
    method="POST"
    target="hidden_iframe"
    >
    <input type="hidden" id="f_user" name="user">
    <input type="hidden" id="f_month" name="month">
    <input type="hidden" id="f_year" name="year">
    <input type="hidden" id="f_category" name="category">
    <input type="hidden" id="f_limit" name="limit">
    </form>

<iframe name="hidden_iframe" style="display:none;"></iframe>


  </main>
</div>

<script type="module">
  import { auth } from "../js/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const userEmailEl = document.getElementById("userEmail");

  const BUDGET_API =
    "https://script.google.com/macros/s/AKfycbxEBMHznfPUobcdKwBlPzdacLo1YyximSm6jLv6ULFLg8u01oLxjwa28qGZ1U179U-0CQ/exec";

  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "../login.html";
      return;
    }
    userEmailEl.textContent = user.email;
    initMonthYear();
    loadBudgets();
  });

  window.logout = () => {
    import("../js/auth.js").then(m => m.logout());
  };

  window.openModal = () =>
    document.getElementById("budgetModal").classList.remove("hidden");

  window.closeModal = () =>
    document.getElementById("budgetModal").classList.add("hidden");

  function initMonthYear() {
    const m = document.getElementById("budgetMonth");
    const y = document.getElementById("budgetYear");
    m.innerHTML = ""; y.innerHTML = "";

    for (let i = 1; i <= 12; i++) {
      m.innerHTML += `<option value="${i}">ThÃ¡ng ${i}</option>`;
    }

    const now = new Date().getFullYear();
    for (let i = now - 2; i <= now + 5; i++) {
      y.innerHTML += `<option value="${i}">${i}</option>`;
    }

    m.value = new Date().getMonth() + 1;
    y.value = now;
  }

  window.saveBudget = () => {
  const limit = document.getElementById("budgetLimit").value;
  if (!limit) {
    alert("ChÆ°a nháº­p háº¡n má»©c");
    return;
  }

  document.getElementById("f_user").value = auth.currentUser.email;
  document.getElementById("f_month").value = document.getElementById("budgetMonth").value;
  document.getElementById("f_year").value = document.getElementById("budgetYear").value;
  document.getElementById("f_category").value = document.getElementById("categorySelect").value;
  document.getElementById("f_limit").value = limit;

  document.getElementById("budgetForm").submit();

  closeModal();

  setTimeout(loadBudgets, 500); // Ä‘á»£i sheet ghi xong
};


  function addBudgetCard(b) {
    const spent = b.spent || 0;
    const limit = b.limit;
    const percent = Math.min(100, spent / limit * 100);

    document.getElementById("budgetList").innerHTML += `
      <div class="budget-card ${spent > limit ? "over" : ""}">
        <h3>${b.month}/${b.year} - ${b.category}</h3>
        <p>Háº¡n má»©c: ${limit.toLocaleString()} VND</p>
        <p>ÄÃ£ tiÃªu: ${spent.toLocaleString()} VND</p>
        <p>CÃ²n láº¡i: ${(limit - spent).toLocaleString()} VND</p>
        <div class="progress">
          <div class="bar" style="width:${percent}%"></div>
        </div>
        <button onclick="deleteBudget('${b.user}','${b.month}','${b.year}','${b.category}', this)">âŒ XÃ³a</button>
      </div>
    `;
  }

  async function loadBudgets() {
    const res = await fetch(`${BUDGET_API}?user=${auth.currentUser.email}`);
    const data = await res.json();
    document.getElementById("budgetList").innerHTML = "";
    data.forEach(addBudgetCard);
  }

  window.deleteBudget = async (user, month, year, category, btn) => {
    if (!confirm("XÃ³a ngÃ¢n sÃ¡ch nÃ y?")) return;

    await fetch(BUDGET_API, {
      method: "DELETE",
      body: JSON.stringify({ user, month, year, category })
    });

    btn.closest(".budget-card").remove();
  };
</script>

</body>
</html>
