<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Finance BI</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>üíº Finance BI</h1>
        <p class="user-email">üë§ <span id="userEmail">T√†i kho·∫£n</span></p>
        <button onclick="logout()" class="btn-logout">ƒêƒÉng xu·∫•t</button>
      </div>

      <nav class="sidebar-nav">
        <a class="active">üìä Thu ‚Äì Chi</a>
        <a>üìà Dashboard</a>
        <a>üí∞ Ng√¢n s√°ch</a>
        <a>üîç Insight</a>
      </nav>
    </aside>

    <main class="main">
      <h2 class="title">‚ù§Ô∏è Finance Dashboard</h2>

      <!-- FORM G·ª¨I D·ªÆ LI·ªÜU -->
      <form id="transactionForm"
        action="https://script.google.com/macros/s/AKfycbyHLR0j1jC7fyIV3isHEeipOCvtUs3tZFfGU0uPXn2GQp24orD2M7ifGm6qjbLUC06QNA/exec"
        method="POST" target="hidden_iframe">
        <input type="hidden" name="user_id" id="user_id" />
        <!-- C√°c input ·∫©n s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông tr∆∞·ªõc khi submit -->

        <label>Ng√†y giao d·ªãch</label>
        <input type="date" name="date" required />

        <label>Lo·∫°i giao d·ªãch</label>
        <select name="type" required>
          <option value="Thu">Thu</option>
          <option value="Chi">Chi</option>
        </select>

        <label>Danh m·ª•c</label>
        <select name="category_id" required>
          <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
          <option value="Nh√† ·ªü">Nh√† ·ªü</option>
          <option value="Di chuy·ªÉn">Di chuy·ªÉn</option>
          <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
          <option value="L∆∞∆°ng">L∆∞∆°ng</option>
          <option value="Th∆∞·ªüng">Th∆∞·ªüng</option>
        </select>

        <label>S·ªë ti·ªÅn</label>
        <input type="number" name="amount" required min="0" step="1" />

        <label>Ghi ch√∫</label>
        <input type="text" name="note" />

        <button type="submit">G·ª≠i</button>
      </form>
      <!--hieu -->
      <div id="summary-section">
        <h3>L·ªãch s·ª≠ chi ti√™u</h3>
        <table id="summary-table" class="data-table"></table>
        <!-- B·∫£ng t·ªïng h·ª£p -->
        <h3>D·ª± b√°o th√°ng t·ªõi</h3>
        <table id="du-bao-table" class="data-table"></table>
        <!-- B·∫£ng d·ª± b√°o -->
      </div>
      <!--hieu -->
      <div id="trend-section">
        <h3>Thay ƒë·ªïi % chi ti√™u theo th√°ng</h3>
        <table id="change-pct-table" class="data-table"></table>
        <h3>Xu h∆∞·ªõng t·ªïng th·ªÉ</h3>
        <table id="trends-table" class="data-table"></table>
        <h3>Bi·ªÉu ƒë·ªì xu h∆∞·ªõng</h3>
        <img id="trend-chart" src="../images/xu_huong_chi.png"
          alt="Bi·ªÉu ƒë·ªì xu h∆∞·ªõng chi" style="width: 100%; max-width: 600px" />
      </div>

      <iframe name="hidden_iframe" style="display: none"></iframe>
    </main>
  </div>

  <!-- S·ª≠ d·ª•ng module Firebase -->
  <script type="module">
    import { auth } from "../js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const form = document.getElementById("transactionForm");
    const userEmailEl = document.getElementById("userEmail");
    const userIdInput = document.getElementById("user_id");

    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "../login.html";
        return;
      }
      userEmailEl.textContent = user.email;
      userIdInput.value = user.uid; // G√°n UID v√†o hidden input
    });

    // hieu
    //-----------------------------------------------------------
    // Fetch v√† hi·ªÉn th·ªã d·ªØ li·ªáu Summary_Chi
    function loadSummaryChi() {
      const apiUrl =
        "https://script.google.com/macros/s/AKfycbzCSgrYuVx-uo2f5ZewQJlIgJISNcVKFmbUgPLeBGK92HTu-u59brpZeKzVS7Vu2VfUgQ/exec?type=summary_chi";

      fetch(apiUrl)
        .then((res) => res.json())
        .then((data) => {
          const table = document.getElementById("summary-table");
          table.innerHTML = "";

          data
            // üëâ L·ªåC ROW R·ªñNG
            .filter(
              (row) =>
                row &&
                row.some(
                  (cell) =>
                    cell !== "" &&
                    cell !== null &&
                    cell !== undefined
                )
            )
            .forEach((row, index) => {
              const tr = document.createElement("tr");
              row.forEach((cell) => {
                const td = document.createElement(
                  index === 0 ? "th" : "td"
                );
                td.textContent = cell;
                tr.appendChild(td);
              });
              table.appendChild(tr);
            });
        })
        .catch((err) =>
          console.error("L·ªói fetch Summary_Chi:", err)
        );
    }


    // Fetch v√† hi·ªÉn th·ªã d·ªØ li·ªáu Du_Bao
    function loadDuBao() {
      const apiUrl =
        "https://script.google.com/macros/s/AKfycbzCSgrYuVx-uo2f5ZewQJlIgJISNcVKFmbUgPLeBGK92HTu-u59brpZeKzVS7Vu2VfUgQ/exec?type=du_bao";

      fetch(apiUrl)
        .then((res) => res.json())
        .then((data) => {
          const table = document.getElementById("du-bao-table");
          table.innerHTML = "";

          data
            .filter(
              (row) =>
                row &&
                row.some(
                  (cell) =>
                    cell !== "" &&
                    cell !== null &&
                    cell !== undefined
                )
            )
            .forEach((row, index) => {
              const tr = document.createElement("tr");
              row.forEach((cell) => {
                const td = document.createElement(
                  index === 0 ? "th" : "td"
                );
                td.textContent = cell;
                tr.appendChild(td);
              });
              table.appendChild(tr);
            });
        })
        .catch((err) =>
          console.error("L·ªói fetch Du_Bao:", err)
        );
    }

    // Load b·∫£ng thay ƒë·ªïi %
    function loadChangePct() {
      fetch("https://script.google.com/macros/s/AKfycbwz78_UNY6sIVMmvJuMJSVmEBeMEKBFpvJNb4Rut6aWjiiHw4w8c0NlkyMctzu7_4JYQw/exec?type=change_pct")
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("change-pct-table");
          table.innerHTML = "";

          // Header
          const trHeader = document.createElement("tr");
          ["Th√°ng", "Danh m·ª•c", "T·ªïng chi", "% Thay ƒë·ªïi"].forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            trHeader.appendChild(th);
          });
          table.appendChild(trHeader);

          data.forEach(row => {
            const tr = document.createElement("tr");

            const period = String(row.period);
            const periodText = `${period.slice(0, 4)}-${period.slice(4)}`;

            tr.innerHTML = `
          <td>${periodText}</td>
          <td>${row.category_final}</td>
          <td>${row.Tong_Chi_Abs.toLocaleString("vi-VN")}</td>
          <td>${row.Change_Pct.toFixed(2)}%</td>
        `;
            table.appendChild(tr);
          });
        })
        .catch(err => console.error("change_pct l·ªói:", err));
    }

    function loadTrends() {
      fetch("https://script.google.com/macros/s/AKfycbwz78_UNY6sIVMmvJuMJSVmEBeMEKBFpvJNb4Rut6aWjiiHw4w8c0NlkyMctzu7_4JYQw/exec?type=trends")
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("trends-table");
          table.innerHTML = "";

          const trHeader = document.createElement("tr");
          ["Xu h∆∞·ªõng"].forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            trHeader.appendChild(th);
          });
          table.appendChild(trHeader);

          data.forEach(row => {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.textContent = row.trend;
            tr.appendChild(td);
            table.appendChild(tr);
          });
        })
        .catch(err => console.error("trends l·ªói:", err));
    }

    // Load khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // ... code c≈© ...
        loadSummaryChi(); // Load t√≠nh nƒÉng 1
        loadDuBao();
        loadChangePct(); // Load thay ƒë·ªïi %
        loadTrends();    // Load xu h∆∞·ªõng
      }
    });
    //-----------------------------------------------------------

    // X·ª≠ l√Ω logout (d√πng h√†m trong auth.js)
    window.logout = () => {
      import("../js/auth.js").then((module) => {
        module.logout();
      });
    };

    // Can thi·ªáp tr∆∞·ªõc khi submit form
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const date = formData.get("date"); // YYYY-MM-DD
      const amount = parseFloat(formData.get("amount")) || 0;
      const type = formData.get("type");
      const uid = userIdInput.value;

      if (!date || !uid) {
        alert("‚ùå Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn ng√†y h·ª£p l·ªá.");
        return;
      }

      // T√≠nh to√°n c√°c tr∆∞·ªùng b·ªï sung
      const amount_signed = type === "Chi" ? -amount : amount;
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");

      // T·∫°o transaction_id duy nh·∫•t
      const now = new Date();
      const timestamp = now.toISOString().replace(/[-:T]/g, "").slice(0, 14); // vd: 20260113153022
      const random = Math.floor(Math.random() * 1000)
        .toString()
        .padStart(3, "0");
      const transaction_id = `${timestamp}_${uid}_${random}`;

      // Th√™m c√°c tr∆∞·ªùng ·∫©n v√†o form
      const addField = (name, value) => {
        let input = form.querySelector(`input[name="${name}"]`);
        if (!input) {
          input = document.createElement("input");
          input.type = "hidden";
          input.name = name;
          form.appendChild(input);
        }
        input.value = value;
      };

      addField("transaction_id", transaction_id);
      addField("amount_signed", amount_signed);
      addField("year", year);
      addField("month", month);

      // Submit form
      form.submit();

      // Th√¥ng b√°o & reset
      setTimeout(() => {
        alert("‚úÖ ƒê√£ l∆∞u giao d·ªãch th√†nh c√¥ng!");
        form.reset();
        // X√≥a c√°c input ·∫©n
        ["transaction_id", "amount_signed", "year", "month"].forEach(
          (name) => {
            const el = form.querySelector(`input[name="${name}"]`);
            if (el) el.remove();
          }
        );
      }, 400);
    });
  </script>
</body>

</html>