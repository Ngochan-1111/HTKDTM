<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Finance BI - Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ’¼ Finance BI</h1>
      <p class="user-email">ğŸ‘¤ <span id="userEmail">TÃ i khoáº£n</span></p>
      <button onclick="logout()" class="btn-logout">ÄÄƒng xuáº¥t</button>
    </div>
    <nav class="sidebar-nav">
      <a href="index.html">ğŸ“Š Thu â€“ Chi</a>
      <a class="active">ğŸ“ˆ Dashboard</a>
      <a href="#">ğŸ’° NgÃ¢n sÃ¡ch</a>
      <a href="#">ğŸ” Insight</a>
    </nav>
  </aside>

  <main class="main">
    <h2 class="title">â¤ï¸ Finance Dashboard</h2>

    <div class="filters-container" style="background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 20px;">
      <div class="dropdown-filters" style="display: flex; gap: 20px; margin-bottom: 15px; align-items: center;">
        <div>
          <label><b>ThÃ¡ng:</b> </label>
          <select id="filterMonth" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
            <option value="all">Táº¥t cáº£</option>
            <option value="1">ThÃ¡ng 1</option><option value="2">ThÃ¡ng 2</option>
            <option value="3">ThÃ¡ng 3</option><option value="4">ThÃ¡ng 4</option>
            <option value="5">ThÃ¡ng 5</option><option value="6">ThÃ¡ng 6</option>
            <option value="7">ThÃ¡ng 7</option><option value="8">ThÃ¡ng 8</option>
            <option value="9">ThÃ¡ng 9</option><option value="10">ThÃ¡ng 10</option>
            <option value="11">ThÃ¡ng 11</option><option value="12">ThÃ¡ng 12</option>
          </select>
        </div>
        <div>
          <label><b>NÄƒm:</b> </label>
          <select id="filterYear" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
          </select>
        </div>
      </div>

      <div class="preset-buttons" style="display: flex; gap: 10px; border-top: 1px solid #eee; padding-top: 15px;">
        <span style="font-size: 14px; color: #666; align-self: center;">âš¡ Xem nhanh:</span>
        <button onclick="setPreset('today')" style="cursor:pointer; padding: 6px 12px; border-radius: 20px; border: 1px solid #3498db; background: #ebf5fb; color: #3498db;">HÃ´m nay</button>
        <button onclick="setPreset('7days')" style="cursor:pointer; padding: 6px 12px; border-radius: 20px; border: 1px solid #3498db; background: #ebf5fb; color: #3498db;">7 ngÃ y qua</button>
        <button onclick="setPreset('thisMonth')" style="cursor:pointer; padding: 6px 12px; border-radius: 20px; border: 1px solid #3498db; background: #ebf5fb; color: #3498db;">ThÃ¡ng nÃ y</button>
        <button onclick="setPreset('thisYear')" style="cursor:pointer; padding: 6px 12px; border-radius: 20px; border: 1px solid #3498db; background: #ebf5fb; color: #3498db;">NÄƒm nay</button>
      </div>
    </div>

    <div id="dashboard" style="margin-top: 25px;">
      <h2>ğŸ“Š Dashboard Tá»•ng quan</h2>
      <div class="stats-container">
        <div class="stat-card">
          <h3>Tá»•ng thu</h3>
          <p style="color: #2ecc71;"><span id="total-income">0</span> â‚«</p>
        </div>
        <div class="stat-card">
          <h3>Tá»•ng chi</h3>
          <p style="color: #e74c3c;"><span id="total-expense">0</span> â‚«</p>
        </div>
        <div id="balance-card" class="stat-card">
          <h3>Sá»‘ dÆ°</h3>
          <p><span id="balance">0</span> â‚«</p>
        </div>
      </div>

      <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px;">
        <div style="flex: 1; min-width: 350px; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
          <h2 style="font-size: 1.1rem; text-align: center; margin-bottom: 20px;">ğŸ“Š PhÃ¢n tÃ­ch Tá»· trá»ng Chi</h2>
          <canvas id="categoryChart"></canvas>
          <div id="top-categories" style="margin-top: 25px; font-size: 14px; border-top: 1px solid #f0f0f0; padding-top: 15px;"></div>
        </div>

        <div style="flex: 1; min-width: 350px; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
          <h2 style="font-size: 1.1rem; text-align: center; margin-bottom: 20px;">ğŸ“ˆ Biá»ƒu Ä‘á»“ xu hÆ°á»›ng Thu - Chi</h2>
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>
  </main>
</div>



<script type="module">
  import { auth } from "../js/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSFrDLFS04b7WmZCqC7yxWkhRZJKfyac8x_DKPOVEXE0-ropwdeEJYWeJfPOXlPNNcEa1JY3pAFfbf-/pub?gid=1321142563&single=true&output=csv`;

  let currentUserId = null;
  let categoryChart = null;
  let trendChart = null;
  let dateFilterMode = null; // null, 'today', hoáº·c '7days'

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "../login.html";
      return;
    }
    currentUserId = user.uid;
    document.getElementById("userEmail").textContent = user.email;
    loadDashboard();
    setInterval(loadDashboard, 30000);
  });

  // GÃ¡n hÃ m vÃ o window Ä‘á»ƒ gá»i Ä‘Æ°á»£c tá»« onclick HTML
  window.setPreset = (mode) => {
    const monthSelect = document.getElementById("filterMonth");
    const yearSelect = document.getElementById("filterYear");
    const now = new Date();

    dateFilterMode = mode;

    if (mode === 'thisMonth') {
      monthSelect.value = now.getMonth() + 1;
      yearSelect.value = now.getFullYear();
      dateFilterMode = null;
    } else if (mode === 'thisYear') {
      monthSelect.value = 'all';
      yearSelect.value = now.getFullYear();
      dateFilterMode = null;
    }
    
    loadDashboard();
  };

  document.getElementById("filterMonth").addEventListener("change", () => { dateFilterMode = null; loadDashboard(); });
  document.getElementById("filterYear").addEventListener("change", () => { dateFilterMode = null; loadDashboard(); });

  async function loadDashboard() {
    const selectedMonth = document.getElementById("filterMonth").value;
    const selectedYear = document.getElementById("filterYear").value;

    try {
      const response = await fetch(CSV_URL);
      const csvText = await response.text();
      const lines = csvText.trim().split('\n');
      if (lines.length <= 1) return;

      let totalIncome = 0, totalExpense = 0;
      const categoryData = {};
      const dailyData = {};
      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        if (cols.length < 10) continue;

        const createdId = cols[6]?.replace(/"/g, '').trim();
        if (createdId !== currentUserId) continue;

        const date = cols[1]?.trim(); 
        const amount = parseFloat(cols[2]) || 0;
        const type = cols[3]?.replace(/"/g, '').trim(); 
        const category = cols[4]?.replace(/"/g, '').trim();
        const year = cols[8]?.trim(); 
        const month = cols[9]?.trim(); 

        // LOGIC Lá»ŒC THÃ”NG MINH
        let isPass = false;
        if (dateFilterMode === 'today') {
          if (date === todayStr) isPass = true;
        } else if (dateFilterMode === '7days') {
          const tDate = new Date(date);
          const diffDays = (now - tDate) / (1000 * 60 * 60 * 24);
          if (diffDays >= 0 && diffDays <= 7) isPass = true;
        } else {
          if ((selectedMonth === "all" || month === selectedMonth) && (year === selectedYear)) isPass = true;
        }

        if (!isPass) continue;

        if (type === "Thu") {
          totalIncome += amount;
        } else if (type === "Chi") {
          totalExpense += amount;
          categoryData[category] = (categoryData[category] || 0) + amount;
        }

        if (!dailyData[date]) dailyData[date] = { thu: 0, chi: 0 };
        if (type === "Thu") dailyData[date].thu += amount;
        else dailyData[date].chi += amount;
      }

      // Cáº­p nháº­t UI
      const balance = totalIncome - totalExpense;
      document.getElementById("total-income").textContent = totalIncome.toLocaleString('vi-VN');
      document.getElementById("total-expense").textContent = totalExpense.toLocaleString('vi-VN');
      const balanceEl = document.getElementById("balance");
      balanceEl.textContent = balance.toLocaleString('vi-VN');

      const balanceCard = document.getElementById("balance-card");
      if (balance < 0) {
        balanceCard.style.background = "#fff5f5";
        balanceEl.style.color = "#e74c3c";
      } else {
        balanceCard.style.background = "#fff";
        balanceEl.style.color = "#2ecc71";
      }

      renderCharts(categoryData, dailyData);
      renderCategoryList(categoryData, totalExpense);

    } catch (error) { console.error("Error:", error); }
  }

  function renderCategoryList(categoryData, totalExpense) {
    const listDiv = document.getElementById("top-categories");
    const sorted = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
    listDiv.innerHTML = "<b>PhÃ¢n bá»• chi tiÃªu:</b><br>";
    sorted.forEach(([cat, val]) => {
      const p = totalExpense > 0 ? ((val / totalExpense) * 100).toFixed(1) : 0;
      listDiv.innerHTML += `<div style="display:flex; justify-content:space-between; margin: 8px 0; color:#444;">
        <span>ğŸ“ ${cat}</span>
        <span>${val.toLocaleString('vi-VN')} â‚« (${p}%)</span>
      </div>`;
    });
  }

  function renderCharts(categoryData, dailyData) {
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    if (categoryChart) categoryChart.destroy();
    categoryChart = new Chart(catCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(categoryData),
        datasets: [{
          data: Object.values(categoryData),
          backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
        }]
      },
      options: { plugins: { legend: { position: 'bottom' } }, cutout: '65%' }
    });

    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const sortedDates = Object.keys(dailyData).sort();
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: sortedDates,
        datasets: [
          { label: 'Thu nháº­p', data: sortedDates.map(d => dailyData[d].thu), borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.1)', tension: 0.4, fill: true },
          { label: 'Chi tiÃªu', data: sortedDates.map(d => dailyData[d].chi), borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.4, fill: true }
        ]
      },
      options: { responsive: true, plugins: { legend: { position: 'top' } } }
    });
  }

  window.logout = () => { import("../js/auth.js").then(m => m.logout()); };
</script>
</body>
</html>