<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Finance BI â€“ Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ’¼ Finance BI</h1>
      <p class="user-email">ğŸ‘¤ <span id="userEmail">TÃ i khoáº£n</span></p>
      <button class="btn-logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
    </div>
    <nav class="sidebar-nav">
      <a href="index.html" class="nav-link">ğŸ  Trang chá»§</a>
      <a href="transactions.html" class="nav-link">ğŸ“Š Thu â€“ Chi</a>
      <a href="dashboard.html" class="nav-link active">ğŸ“ˆ Dashboard</a>
      <a href="budget.html" class="nav-link">ğŸ’° NgÃ¢n sÃ¡ch</a>
      <a href="insight.html" class="nav-link">ğŸ” Insight</a>
      <a href="reminders.html" class="nav-link">ğŸ”” Nháº¯c nhá»Ÿ</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <h2 class="title">ğŸ“ˆ Dashboard tá»•ng quan</h2>

    <!-- FILTER -->
    <section class="filter-box">
      <div class="filter-row">
        <div>
          <label>ThÃ¡ng</label>
          <select id="filterMonth">
            <option value="all">Táº¥t cáº£</option>
            <option value="1">ThÃ¡ng 1</option><option value="2">ThÃ¡ng 2</option>
            <option value="3">ThÃ¡ng 3</option><option value="4">ThÃ¡ng 4</option>
            <option value="5">ThÃ¡ng 5</option><option value="6">ThÃ¡ng 6</option>
            <option value="7">ThÃ¡ng 7</option><option value="8">ThÃ¡ng 8</option>
            <option value="9">ThÃ¡ng 9</option><option value="10">ThÃ¡ng 10</option>
            <option value="11">ThÃ¡ng 11</option><option value="12">ThÃ¡ng 12</option>
          </select>
        </div>

        <div>
          <label>NÄƒm</label>
          <select id="filterYear">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
          </select>
        </div>
      </div>

      <div class="preset-row">
        <span>âš¡ Xem nhanh:</span>
        <button onclick="setPreset('today')">HÃ´m nay</button>
        <button onclick="setPreset('7days')">7 ngÃ y</button>
        <button onclick="setPreset('thisMonth')">ThÃ¡ng nÃ y</button>
        <button onclick="setPreset('thisYear')">NÄƒm nay</button>
      </div>
    </section>

    <!-- STATS -->
    <section class="stats-container">
      <div class="stat-card income">
        <h3>Tá»•ng thu</h3>
        <p><span id="total-income">0</span> â‚«</p>
      </div>

      <div class="stat-card expense">
        <h3>Tá»•ng chi</h3>
        <p><span id="total-expense">0</span> â‚«</p>
      </div>

      <div class="stat-card balance" id="balance-card">
        <h3>Sá»‘ dÆ°</h3>
        <p><span id="balance">0</span> â‚«</p>
      </div>
    </section>

    <!-- CHART -->
    <section class="chart-grid">
      <div class="chart-card">
        <h3>ğŸ“Š Tá»· trá»ng chi tiÃªu</h3>
        <canvas id="categoryChart"></canvas>
      </div>

      <div class="chart-card">
        <h3>ğŸ“ˆ Xu hÆ°á»›ng thu â€“ chi</h3>
        <canvas id="trendChart"></canvas>
      </div>
    </section>

  </main>
</div>

<!-- SCRIPT -->
<script type="module">
  import { auth } from "../js/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFrDLFS04b7WmZCqC7yxWkhRZJKfyac8x_DKPOVEXE0-ropwdeEJYWeJfPOXlPNNcEa1JY3pAFfbf-/pub?gid=1321142563&single=true&output=csv";

  const userEmailEl = document.getElementById("userEmail");
  const filterMonth = document.getElementById("filterMonth");
  const filterYear = document.getElementById("filterYear");

  const totalIncomeEl = document.getElementById("total-income");
  const totalExpenseEl = document.getElementById("total-expense");
  const balanceEl = document.getElementById("balance");

  let currentUserId = null;
  let categoryChart = null;
  let trendChart = null;
  let dateFilterMode = null;

  onAuthStateChanged(auth, (user) => {
    if (!user) return window.location.href = "../login.html";
    currentUserId = user.uid;
    userEmailEl.textContent = user.email;
    loadDashboard();
  });

  window.setPreset = (mode) => {
    dateFilterMode = mode;
    const now = new Date();

    if (mode === "thisMonth") {
      filterMonth.value = now.getMonth() + 1;
      filterYear.value = now.getFullYear();
      dateFilterMode = null;
    }

    if (mode === "thisYear") {
      filterMonth.value = "all";
      filterYear.value = now.getFullYear();
      dateFilterMode = null;
    }

    loadDashboard();
  };

  filterMonth.onchange = filterYear.onchange = () => {
    dateFilterMode = null;
    loadDashboard();
  };

  async function loadDashboard() {
    const res = await fetch(CSV_URL);
    const rows = (await res.text()).trim().split("\n");

    let income = 0, expense = 0;
    const cat = {}, daily = {};
    const now = new Date();
    const today = now.toISOString().split("T")[0];

    for (let i = 1; i < rows.length; i++) {
      const c = rows[i].split(",");
      if (c.length < 10) continue;

      const createdId = c[6]?.replace(/"/g, "").trim();
      if (createdId !== currentUserId) continue;

      const date = c[1]?.replace(/"/g, "").trim();

      // âœ… FIX CHUáº¨N TIá»€N VIá»†T
      const amount = Number(
        c[2]
          ?.replace(/"/g, "")
          .replace(/\./g, "")
          .replace(/,/g, "")
      ) || 0;

      const type = c[3]?.replace(/"/g, "").trim();
      const category = c[4]?.replace(/"/g, "").trim();
      const year = c[8]?.trim();
      const month = c[9]?.trim();

      let pass = false;
      if (dateFilterMode === "today") {
        pass = date === today;
      } else if (dateFilterMode === "7days") {
        const diff = (now - new Date(date)) / 864e5;
        pass = diff >= 0 && diff <= 7;
      } else {
        pass =
          (filterMonth.value === "all" || month === filterMonth.value) &&
          year === filterYear.value;
      }

      if (!pass) continue;

      if (type === "Thu") income += amount;
      if (type === "Chi") {
        expense += amount;
        cat[category] = (cat[category] || 0) + amount;
      }

      daily[date] ??= { thu: 0, chi: 0 };
      if (type === "Thu") daily[date].thu += amount;
      if (type === "Chi") daily[date].chi += amount;
    }

    totalIncomeEl.textContent = income.toLocaleString("vi-VN");
    totalExpenseEl.textContent = expense.toLocaleString("vi-VN");
    balanceEl.textContent = (income - expense).toLocaleString("vi-VN");

    renderCharts(cat, daily);
  }

  function renderCharts(cat, daily) {
    if (categoryChart) categoryChart.destroy();
    if (trendChart) trendChart.destroy();

    categoryChart = new Chart(
      document.getElementById("categoryChart"),
      {
        type: "doughnut",
        data: {
          labels: Object.keys(cat),
          datasets: [{ data: Object.values(cat) }]
        },
        options: { cutout: "65%" }
      }
    );

    const dates = Object.keys(daily).sort();
    trendChart = new Chart(
      document.getElementById("trendChart"),
      {
        type: "line",
        data: {
          labels: dates,
          datasets: [
            { label: "Thu", data: dates.map(d => daily[d].thu) },
            { label: "Chi", data: dates.map(d => daily[d].chi) }
          ]
        }
      }
    );
  }

  window.logout = () => import("../js/auth.js").then(m => m.logout());
</script>

<script src="../js/chatbot.js"></script>
</body>
</html>