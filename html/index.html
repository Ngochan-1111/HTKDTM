<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Finance BI</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>

<div class="container">

  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ’¼ Finance BI</h1>
      <p class="user-email">ğŸ‘¤ <span id="userEmail">TÃ i khoáº£n</span></p>
      <button onclick="logout()" class="btn-logout">ÄÄƒng xuáº¥t</button>
    </div>

    <nav class="sidebar-nav">
      <a class="nav-link active" data-section="transactions">ğŸ“Š Thu â€“ Chi</a>
      <a class="nav-link" data-section="dashboard">ğŸ“ˆ Dashboard</a>
      <a class="nav-link" data-section="budget">ğŸ’° NgÃ¢n sÃ¡ch</a>
      <a class="nav-link" data-section="insight">ğŸ” Insight</a>
      <a class="nav-link" data-section="reminders">ğŸ”” Nháº¯c nhá»Ÿ</a>
    </nav>
  </aside>

  <main class="main">
    <section id="section-transactions" class="page-section active">
      <h2 class="title, form-page" style="padding: unset;">
        â¤ï¸ Finance Dashboard
      </h2>

      <!-- FORM Gá»¬I Dá»® LIá»†U -->
      <div class="form-page">
        <form
        id="transactionForm"
        action="https://script.google.com/macros/s/AKfycbyHLR0j1jC7fyIV3isHEeipOCvtUs3tZFfGU0uPXn2GQp24orD2M7ifGm6qjbLUC06QNA/exec"
        method="POST"
        target="hidden_iframe"
        class="form-container">
          <input type="hidden" name="user_id" id="user_id">
          <!-- CÃ¡c input áº©n sáº½ Ä‘Æ°á»£c thÃªm tá»± Ä‘á»™ng trÆ°á»›c khi submit -->

          <label>NgÃ y giao dá»‹ch</label>
          <input type="date" name="date" required>

          <label>Loáº¡i giao dá»‹ch</label>
          <select name="type" required>
            <option value="Thu">Thu</option>
            <option value="Chi">Chi</option>
          </select>

          <label>Danh má»¥c</label>
          <select name="category_id" required>
            <option value="Ä‚n uá»‘ng">Ä‚n uá»‘ng</option>
            <option value="NhÃ  á»Ÿ">NhÃ  á»Ÿ</option>
            <option value="Di chuyá»ƒn">Di chuyá»ƒn</option>
            <option value="Giáº£i trÃ­">Giáº£i trÃ­</option>
            <option value="LÆ°Æ¡ng">LÆ°Æ¡ng</option>
            <option value="ThÆ°á»Ÿng">ThÆ°á»Ÿng</option>
          </select>

          <label>Sá»‘ tiá»n</label>
          <input type="number" name="amount" required min="0" step="1">

          <label>Ghi chÃº</label>
          <input type="text" name="note">

          <button type="submit">Gá»­i</button>
        </form>
       </div>
    </section>

    <section id="section-reminders" class="page-section" style="display:none;">
      <div class="reminder-header">
        <h2 class="title form-page"><span>ğŸ””</span> Nháº¯c Thanh ToÃ¡n HÃ³a ÄÆ¡n</h2>
        <p class="hint form-page">Äá»ƒ Ä‘á»“ng bá»™ lá»‹ch thanh toÃ¡n, hÃ£y káº¿t ná»‘i vá»›i Google Calendar</p>
        <div class="form-page">
          <button id="connectCalendarBtn" class="btn-connect-calendar">ğŸ”— Káº¿t ná»‘i Google Calendar</button>
        </div>
        <div id="calendarStatus" class="calendar-status form-page" style="display:none;"></div>
      </div>

      <div class="reminder-form-wrapper form-page">
        <form id="reminderForm" class="form-container" style="max-width: 560px">
          <h3>ThÃªm nháº¯c nhá»Ÿ</h3>
          <label>TÃªn hÃ³a Ä‘Æ¡n</label>
          <input type="text" id="billName" required placeholder="VD: Tiá»n Ä‘iá»‡n thÃ¡ng 11">
          <span id="error-billName" class="error-text" style="display:none;"></span>

          <label>Ghi chÃº</label>
          <input type="text" id="notes" placeholder="Ghi chÃº thÃªm...">

          <label>NgÃ y giá» nháº¯c</label>
          <input type="datetime-local" id="reminderDate" required>
          <span id="error-reminderDate" class="error-text" style="display:none;"></span>

          <label>Sá»‘ tiá»n (VND)</label>
          <input type="number" id="amount" min="0" step="1000" required>
          <span id="error-amount" class="error-text" style="display:none;"></span>
          
          <div style="display:flex;">
            <div>
              <label>Danh má»¥c</label>
              <select id="category" required>
                <option value="">-- Chá»n danh má»¥c --</option>
                <option value="Äiá»‡n">Äiá»‡n</option>
                <option value="NÆ°á»›c">NÆ°á»›c</option>
                <option value="Internet">Internet</option>
                <option value="Äiá»‡n thoáº¡i">Äiá»‡n thoáº¡i</option>
                <option value="Tháº» tÃ­n dá»¥ng">Tháº» tÃ­n dá»¥ng</option>
                <option value="KhÃ¡c">KhÃ¡c</option>
              </select>
              <span id="error-category" class="error-text" style="display:none;"></span>
            </div>
            
            <div style="margin-left: 30px;">
              <label>Láº·p láº¡i</label>
              <select id="repeat">
                <option value="none">KhÃ´ng láº·p</option>
                <option value="daily">HÃ ng ngÃ y</option>
                <option value="weekly">HÃ ng tuáº§n</option>
                <option value="monthly">HÃ ng thÃ¡ng</option>
                <option value="yearly">HÃ ng nÄƒm</option>
              </select>
            </div>
            
          </div>
          

          <div id="formMessage" class="form-message" style="display:none;"></div>

          <button type="submit" class="form-btn">+ ThÃªm nháº¯c</button>
        </form>
      </div>

      <div class="reminders-list-wrapper">
        <h3>Danh sÃ¡ch nháº¯c nhá»Ÿ</h3>
        <div id="remindersList" class="reminders-list">
          <div class="empty-state">ChÆ°a cÃ³ nháº¯c nhá»Ÿ nÃ o. HÃ£y thÃªm nháº¯c nhá»Ÿ Ä‘áº§u tiÃªn!</div>
        </div>
      </div>
    </section>

    <iframe name="hidden_iframe" style="display:none;"></iframe>
  </main>
</div>

<!-- Sá»­ dá»¥ng module Firebase -->
<script type="module">
  import { auth } from "../js/firebase.js";
  import {
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const form = document.getElementById("transactionForm");
  const userEmailEl = document.getElementById("userEmail");
  const userIdInput = document.getElementById("user_id");

  // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "../login.html";
      return;
    }
    userEmailEl.textContent = user.email;
    userIdInput.value = user.uid; // GÃ¡n UID vÃ o hidden input
    currentUser = user;
    loadReminders();
  });

  // Xá»­ lÃ½ logout (dÃ¹ng hÃ m trong auth.js)
  window.logout = () => {
    import("../js/auth.js").then(module => {
      module.logout();
    });
  };

  // ========================
  // Chuyá»ƒn tab (Thu chi / Nháº¯c nhá»Ÿ)
  // ========================
  const navLinks = document.querySelectorAll(".nav-link");
  const sections = document.querySelectorAll(".page-section");

  navLinks.forEach(link => {
    link.addEventListener("click", () => {
      navLinks.forEach(l => l.classList.remove("active"));
      link.classList.add("active");

      const target = link.getAttribute("data-section");
      sections.forEach(sec => {
        sec.style.display = sec.id === `section-${target}` ? "block" : "none";
        sec.classList.toggle("active", sec.id === `section-${target}`);
      });
    });
  });

  // Can thiá»‡p trÆ°á»›c khi submit form
  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(form);
    const date = formData.get("date"); // YYYY-MM-DD
    const amount = parseFloat(formData.get("amount")) || 0;
    const type = formData.get("type");
    const uid = userIdInput.value;

    if (!date || !uid) {
      alert("âŒ Vui lÃ²ng Ä‘Äƒng nháº­p vÃ  chá»n ngÃ y há»£p lá»‡.");
      return;
    }

    // TÃ­nh toÃ¡n cÃ¡c trÆ°á»ng bá»• sung
    const amount_signed = type === "Chi" ? -amount : amount;
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');

    // Táº¡o transaction_id duy nháº¥t
    const now = new Date();
    const timestamp = now.toISOString().replace(/[-:T]/g, '').slice(0, 14); // vd: 20260113153022
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    const transaction_id = `${timestamp}_${uid}_${random}`;

    // ThÃªm cÃ¡c trÆ°á»ng áº©n vÃ o form
    const addField = (name, value) => {
      let input = form.querySelector(`input[name="${name}"]`);
      if (!input) {
        input = document.createElement("input");
        input.type = "hidden";
        input.name = name;
        form.appendChild(input);
      }
      input.value = value;
    };

    addField("transaction_id", transaction_id);
    addField("amount_signed", amount_signed);
    addField("year", year);
    addField("month", month);

    // Submit form
    form.submit();

    // ThÃ´ng bÃ¡o & reset
    setTimeout(() => {
      alert("âœ… ÄÃ£ lÆ°u giao dá»‹ch thÃ nh cÃ´ng!");
      form.reset();
      // XÃ³a cÃ¡c input áº©n
      ["transaction_id", "amount_signed", "year", "month"].forEach(name => {
        const el = form.querySelector(`input[name="${name}"]`);
        if (el) el.remove();
      });
    }, 400);
  });

  // ========================
  // Nháº¯c nhá»Ÿ
  // ========================
  const REMINDERS_WEBHOOK_URL = "https://tieunhi171.app.n8n.cloud/webhook/fbade263-0260-4a0c-9dbc-fa0b285c7cbf";
  const STORAGE_KEY = "smart_finance_reminders";
  let currentUser = null;

  const reminderForm = document.getElementById("reminderForm");
  const remindersList = document.getElementById("remindersList");
  const connectCalendarBtn = document.getElementById("connectCalendarBtn");

  const reminderDateInput = document.getElementById("reminderDate");
  if (reminderDateInput) {
    const now = new Date();
    now.setHours(now.getHours() + 1);
    reminderDateInput.value = now.toISOString().slice(0, 16);
  }

  if (reminderForm) {
    reminderForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showMessage("Vui lÃ²ng Ä‘Äƒng nháº­p", "error");
        return;
      }

      const formData = {
        billName: document.getElementById("billName").value.trim(),
        notes: document.getElementById("notes").value.trim(),
        category: document.getElementById("category").value,
        reminderDate: document.getElementById("reminderDate").value,
        amount: parseFloat(document.getElementById("amount").value) || 0,
        repeat: document.getElementById("repeat").value,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        createdAt: new Date().toISOString(),
        status: "pending"
      };

      if (!formData.billName) { showError("billName", "Vui lÃ²ng nháº­p tÃªn hÃ³a Ä‘Æ¡n"); return; }
      if (!formData.category) { showError("category", "Vui lÃ²ng chá»n danh má»¥c"); return; }
      if (!formData.reminderDate) { showError("reminderDate", "Vui lÃ²ng chá»n ngÃ y giá» nháº¯c nhá»Ÿ"); return; }
      if (new Date(formData.reminderDate) < new Date()) { showError("reminderDate", "NgÃ y giá» nháº¯c nhá»Ÿ pháº£i trong tÆ°Æ¡ng lai"); return; }
      if (formData.amount <= 0) { showError("amount", "Sá»‘ tiá»n pháº£i lá»›n hÆ¡n 0"); return; }

      clearErrors();

      const submitBtn = reminderForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Äang thÃªm...";

      try {
        const reminderId = `reminder_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        formData.id = reminderId;

        await saveReminderToSheets(formData);
        saveReminderToLocal(formData);
        reminderForm.reset();
        if (reminderDateInput) {
          const next = new Date(); next.setHours(next.getHours() + 1);
          reminderDateInput.value = next.toISOString().slice(0, 16);
        }
        loadReminders();
        showMessage("âœ… ÄÃ£ thÃªm nháº¯c nhá»Ÿ thÃ nh cÃ´ng!", "success");
        scheduleReminderCheck(formData);
      } catch (err) {
        console.error(err);
        showMessage(`âŒ Lá»—i: ${err.message || "KhÃ´ng thá»ƒ lÆ°u nháº¯c nhá»Ÿ"}`, "error");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  }

  if (connectCalendarBtn) {
    connectCalendarBtn.addEventListener("click", () => {
      showCalendarStatus("Äang káº¿t ná»‘i vá»›i Google Calendar...", "info");
      setTimeout(() => {
        showCalendarStatus("âœ… ÄÃ£ káº¿t ná»‘i vá»›i Google Calendar", "connected");
      }, 1000);
    });
  }

  function loadReminders() {
    if (!remindersList) return;
    const reminders = getRemindersFromLocal();
    if (reminders.length === 0) {
      remindersList.innerHTML = '<div class="empty-state">ChÆ°a cÃ³ nháº¯c nhá»Ÿ nÃ o. HÃ£y thÃªm nháº¯c nhá»Ÿ Ä‘áº§u tiÃªn!</div>';
      return;
    }
    reminders.sort((a, b) => new Date(a.reminderDate) - new Date(b.reminderDate));
    remindersList.innerHTML = reminders.map(reminder => {
      const date = new Date(reminder.reminderDate);
      const now = new Date();
      const isOverdue = date < now && reminder.status === "pending";
      const status = isOverdue ? "overdue" : reminder.status;
      return `
        <div class="reminder-item" data-id="${reminder.id}">
          <div class="reminder-content">
            <div class="reminder-title">${escapeHtml(reminder.billName)}</div>
            <div class="reminder-details">
              <div class="reminder-date">ğŸ“… ${formatDateTime(date)}</div>
              ${reminder.category ? `<div>ğŸ“‚ Danh má»¥c: ${escapeHtml(reminder.category)}</div>` : ""}
              ${reminder.notes ? `<div>ğŸ“ ${escapeHtml(reminder.notes)}</div>` : ""}
              ${reminder.repeat !== "none" ? `<div>ğŸ”„ Láº·p láº¡i: ${getRepeatLabel(reminder.repeat)}</div>` : ""}
            </div>
            <div class="reminder-amount">${formatCurrency(reminder.amount)} VNÄ</div>
            <span class="reminder-status status-${status}">${getStatusLabel(status)}</span>
          </div>
          <div class="reminder-actions">
            <button class="btn-action btn-edit" onclick="editReminder('${reminder.id}')">Sá»­a</button>
            <button class="btn-action btn-delete" onclick="deleteReminder('${reminder.id}')">XÃ³a</button>
          </div>
        </div>
      `;
    }).join("");
  }

  async function saveReminderToSheets(reminderData) {
    const res = await fetch(REMINDERS_WEBHOOK_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({...reminderData, type:"reminder"})
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  function saveReminderToLocal(reminder) {
    const reminders = getRemindersFromLocal();
    reminders.push(reminder);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
  }
  function getRemindersFromLocal() {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : [];
  }
  window.deleteReminder = function(id) {
    if (!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a nháº¯c nhá»Ÿ nÃ y?")) return;
    const filtered = getRemindersFromLocal().filter(r => r.id !== id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
    loadReminders();
  };
  window.editReminder = function(id) {
    const reminders = getRemindersFromLocal();
    const reminder = reminders.find(r => r.id === id);
    if (!reminder) return;
    document.getElementById("billName").value = reminder.billName;
    document.getElementById("notes").value = reminder.notes || "";
    document.getElementById("reminderDate").value = reminder.reminderDate.slice(0,16);
    document.getElementById("amount").value = reminder.amount;
    document.getElementById("repeat").value = reminder.repeat;
    deleteReminder(id);
    document.querySelector(".reminder-form-wrapper").scrollIntoView({behavior:"smooth"});
  };

  function scheduleReminderCheck(reminder) {
    const reminderDate = new Date(reminder.reminderDate);
    const delay = reminderDate.getTime() - Date.now();
    if (delay > 0) setTimeout(() => sendReminderEmail(reminder), delay);
  }
  async function sendReminderEmail(reminder) {
    try {
      const res = await fetch(REMINDERS_WEBHOOK_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({type:"send_reminder", reminder, action:"send_email"})
      });
      if (res.ok) {
        const reminders = getRemindersFromLocal();
        const idx = reminders.findIndex(r => r.id === reminder.id);
        if (idx !== -1) {
          reminders[idx].status = "completed";
          localStorage.setItem(STORAGE_KEY, JSON.stringify(reminders));
          loadReminders();
        }
      }
    } catch (err) {
      console.error("Error sending reminder email:", err);
    }
  }
  function checkOverdueReminders() {
    const reminders = getRemindersFromLocal();
    const now = new Date();
    reminders.forEach(r => {
      if (new Date(r.reminderDate) <= now && r.status === "pending") {
        sendReminderEmail(r);
      }
    });
  }
  setInterval(checkOverdueReminders, 60000);

  function showError(fieldId, message) {
    const errorEl = document.getElementById(`error-${fieldId}`);
    if (errorEl) { errorEl.textContent = message; errorEl.style.display = "block"; }
    const input = document.getElementById(fieldId);
    if (input) input.classList.add("error");
  }
  function clearErrors() {
    document.querySelectorAll(".error-text").forEach(el => el.style.display="none");
    document.querySelectorAll(".error").forEach(el => el.classList.remove("error"));
  }
  function showMessage(message, type) {
    const messageEl = document.getElementById("formMessage");
    if (!messageEl) return;
    messageEl.textContent = message;
    messageEl.className = `form-message ${type}`;
    messageEl.style.display = "block";
    setTimeout(() => { messageEl.style.display = "none"; }, 3000);
  }
  function showCalendarStatus(message, type) {
    const statusEl = document.getElementById("calendarStatus");
    if (!statusEl) return;
    statusEl.textContent = message;
    statusEl.className = `calendar-status ${type}`;
    statusEl.style.display = "block";
  }
  function formatDateTime(date) {
    const d = String(date.getDate()).padStart(2,"0");
    const m = String(date.getMonth()+1).padStart(2,"0");
    const y = date.getFullYear();
    const hh = String(date.getHours()).padStart(2,"0");
    const mm = String(date.getMinutes()).padStart(2,"0");
    return `${d}/${m}/${y} ${hh}:${mm}`;
  }
  function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount);
  }
  function getRepeatLabel(repeat) {
    const labels = {daily:"HÃ ng ngÃ y", weekly:"HÃ ng tuáº§n", monthly:"HÃ ng thÃ¡ng", yearly:"HÃ ng nÄƒm"};
    return labels[repeat] || repeat;
  }
  function getStatusLabel(status) {
    const labels = {pending:"Chá» nháº¯c", completed:"ÄÃ£ nháº¯c", overdue:"QuÃ¡ háº¡n"};
    return labels[status] || status;
  }
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>