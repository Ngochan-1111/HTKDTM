<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NgÃ¢n sÃ¡ch | Finance BI</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/budget.css">
</head>
<body>

<div class="container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ’¼ Finance BI</h1>
      <p class="user-email">ğŸ‘¤ <span id="userEmail">TÃ i khoáº£n</span></p>
      <button class="btn-logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
    </div>

    <nav class="sidebar-nav">
      <a href="index.html">ğŸ“Š Thu â€“ Chi</a>
      <a>ğŸ“ˆ Dashboard</a>
      <a class="active">ğŸ’° NgÃ¢n sÃ¡ch</a>
      <a>ğŸ” Insight</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <h2 class="title">ğŸ“Š Láº­p káº¿ hoáº¡ch ngÃ¢n sÃ¡ch</h2>

    <button class="add-budget-btn" onclick="openModal()">â• ThÃªm ngÃ¢n sÃ¡ch</button>

    <div id="budgetList" class="budget-list"></div>

    <!-- MODAL -->
    <div id="budgetModal" class="modal hidden">
      <div class="modal-content">
        <h3>â• ThÃªm ngÃ¢n sÃ¡ch</h3>

        <label>ThÃ¡ng</label>
        <select id="budgetMonth"></select>

        <label>NÄƒm</label>
        <select id="budgetYear"></select>

        <label>Danh má»¥c</label>
        <select id="categorySelect">
          <option value="Ä‚n uá»‘ng">Ä‚n uá»‘ng</option>
          <option value="NhÃ  á»Ÿ">NhÃ  á»Ÿ</option>
          <option value="Di chuyá»ƒn">Di chuyá»ƒn</option>
          <option value="Mua sáº¯m">Mua sáº¯m</option>
          <option value="Giáº£i trÃ­">Giáº£i trÃ­</option>
        </select>

        <label>Háº¡n má»©c (VND)</label>
        <input type="number" id="budgetLimit">

        <div class="modal-actions">
          <button type="button" onclick="saveBudget()">LÆ°u</button>
          <button type="button" class="cancel" onclick="closeModal()">Há»§y</button>
        </div>
      </div>
    </div>

    <!-- FORM POST GIá»NG THUâ€“CHI -->
    <form
    id="budgetForm"
    action="https://script.google.com/macros/s/AKfycbx4OM__SN-pnUFUFhRHmzHFUFKSwXwsEx6KR1PpRKcUG9vo4OfvxyMmjybEgfuH1h4eKA/exec"
    method="POST"
    target="hidden_iframe"
    >
    <input type="hidden" id="f_user" name="user">
    <input type="hidden" id="f_month" name="month">
    <input type="hidden" id="f_year" name="year">
    <input type="hidden" id="f_category" name="category">
    <input type="hidden" id="f_limit" name="limit">
    </form>

<iframe name="hidden_iframe" style="display:none;"></iframe>


  </main>
</div>

<script type="module">
  import { auth } from "../js/firebase.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const userEmailEl = document.getElementById("userEmail");
  const BUDGET_LIST_API = "https://tieunhi171.app.n8n.cloud/webhook/budget/list";
  const BUDGET_DELETE_API = "https://tieunhi171.app.n8n.cloud/webhook/budget/delete";



  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "../login.html";
      return;
    }
    userEmailEl.textContent = user.email;
    initMonthYear();
    loadBudgets();
  });

  window.logout = () => {
    import("../js/auth.js").then(m => m.logout());
  };

  window.openModal = () =>
    document.getElementById("budgetModal").classList.remove("hidden");

  window.closeModal = () =>
    document.getElementById("budgetModal").classList.add("hidden");

  function initMonthYear() {
    const m = document.getElementById("budgetMonth");
    const y = document.getElementById("budgetYear");
    m.innerHTML = ""; y.innerHTML = "";

    for (let i = 1; i <= 12; i++) {
      m.innerHTML += `<option value="${i}">ThÃ¡ng ${i}</option>`;
    }

    const now = new Date().getFullYear();
    for (let i = now - 2; i <= now + 5; i++) {
      y.innerHTML += `<option value="${i}">${i}</option>`;
    }

    m.value = new Date().getMonth() + 1;
    y.value = now;
  }

  window.saveBudget = async () => {
  const payload = {
    user: auth.currentUser.email,
    month: Number(document.getElementById("budgetMonth").value),
    year: Number(document.getElementById("budgetYear").value),
    category: document.getElementById("categorySelect").value,
    limit: Number(document.getElementById("budgetLimit").value)
  };

  if (!payload.limit) {
    alert("âŒ ChÆ°a nháº­p háº¡n má»©c");
    return;
  }

  try {
    await fetch("https://tieunhi171.app.n8n.cloud/webhook/budget/add", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    alert("âœ… LÆ°u ngÃ¢n sÃ¡ch thÃ nh cÃ´ng");

    closeModal();
    loadBudgets(); // reload card
    document.getElementById("budgetLimit").value = "";

  } catch (err) {
    console.error(err);
    alert("âŒ Lá»—i khi lÆ°u ngÃ¢n sÃ¡ch");
  }
};



  function addBudgetCard(b) {
  const spent = Number(b.spent || 0);
  const limit = Number(b.limit);
  const percent = Math.min(100, Math.round(spent / limit * 100));
  const over = spent > limit;

  document.getElementById("budgetList").innerHTML += `
    <div class="budget-card ${over ? "over" : ""}">
      <h3>${b.month}/${b.year} - ${b.category}</h3>

      ${over ? `<div class="alert">âš ï¸ VÆ°á»£t ngÃ¢n sÃ¡ch!</div>` : ""}

      <p>Háº¡n má»©c: ${limit.toLocaleString()} VND</p>
      <p>ÄÃ£ tiÃªu: ${spent.toLocaleString()} VND</p>
      <p>CÃ²n láº¡i: ${(limit - spent).toLocaleString()} VND</p>

      <div class="progress">
        <div class="bar" style="width:${percent}%"></div>
      </div>

      <button class="delete" onclick="deleteBudget(${b.rowNumber}, this)">âŒ XÃ³a</button>
    </div>
  `;
}



  async function loadBudgets() {
  const email = auth.currentUser.email;
  const res = await fetch(`${BUDGET_LIST_API}?user=${email}`);

  const data = await res.json();

  const list = document.getElementById("budgetList");
  list.innerHTML = "";

  data.forEach(b => addBudgetCard(b));
}


  window.deleteBudget = async (rowNumber, btn) => {
  if (!confirm("XÃ³a ngÃ¢n sÃ¡ch nÃ y?")) return;

  try {
    await fetch("https://tieunhi171.app.n8n.cloud/webhook/budget/delete", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ rowNumber })
    });

    btn.closest(".budget-card").remove();
    alert("âœ… ÄÃ£ xÃ³a ngÃ¢n sÃ¡ch");

  } catch (e) {
    console.error(e);
    alert("âŒ XÃ³a tháº¥t báº¡i");
  }
};



</script>

</body>
</html>
