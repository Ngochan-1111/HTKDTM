<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thu Chi - Finance BI</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ’¼ Finance BI</h1>
      <p class="user-email">ğŸ‘¤ <span id="userEmail">TÃ i khoáº£n</span></p>
      <button onclick="logout()" class="btn-logout">ÄÄƒng xuáº¥t</button>
    </div>
    <nav class="sidebar-nav">
      <a href="transactions.html" class="nav-link active">ğŸ“Š Thu â€“ Chi</a>
      <a href="index.html" class="nav-link">ğŸ“ˆ Dashboard</a>
      <a href="#" class="nav-link">ğŸ’° NgÃ¢n sÃ¡ch</a>
      <a href="#" class="nav-link">ğŸ” Insight</a>
      <a href="reminders.html" class="nav-link">ğŸ”” Nháº¯c nhá»Ÿ</a>
    </nav>
  </aside>

  <main class="main">
    <section id="section-transactions" class="page-section active">
      <h2 class="title form-page" style="padding: unset;">â¤ï¸ Finance Dashboard</h2>
      <div class="form-page">
        <form id="transactionForm" action="https://script.google.com/macros/s/AKfycbyHLR0j1jC7fyIV3isHEeipOCvtUs3tZFfGU0uPXn2GQp24orD2M7ifGm6qjbLUC06QNA/exec" method="POST" target="hidden_iframe" class="form-container">
          <input type="hidden" name="user_id" id="user_id">
          <label>NgÃ y giao dá»‹ch</label>
          <input type="date" name="date" required>
          <label>Loáº¡i giao dá»‹ch</label>
          <select name="type" required>
            <option value="Thu">Thu</option>
            <option value="Chi">Chi</option>
          </select>
          <label>Danh má»¥c</label>
          <select name="category_id" required>
            <option value="Ä‚n uá»‘ng">Ä‚n uá»‘ng</option>
            <option value="NhÃ  á»Ÿ">NhÃ  á»Ÿ</option>
            <option value="Di chuyá»ƒn">Di chuyá»ƒn</option>
            <option value="Giáº£i trÃ­">Giáº£i trÃ­</option>
            <option value="LÆ°Æ¡ng">LÆ°Æ¡ng</option>
            <option value="ThÆ°á»Ÿng">ThÆ°á»Ÿng</option>
          </select>
          <label>Sá»‘ tiá»n</label>
          <input type="number" name="amount" required min="0" step="1">
          <label>Ghi chÃº</label>
          <input type="text" name="note">
          <button type="submit">Gá»­i</button>
        </form>
      </div>
    </section>
    <iframe name="hidden_iframe" style="display:none;"></iframe>
  </main>
</div>

<script type="module">
  import { auth } from "../js/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  
  const userIdInput = document.getElementById("user_id");
  const transactionForm = document.getElementById("transactionForm");

  onAuthStateChanged(auth, (user) => {
    if (!user) { window.location.href = "../login.html"; return; }
    document.getElementById("userEmail").textContent = user.email;
    userIdInput.value = user.uid;
  });

  transactionForm.addEventListener("submit", function (e) {
    const formData = new FormData(transactionForm);
    const date = formData.get("date");
    const amount = parseFloat(formData.get("amount")) || 0;
    const type = formData.get("type");
    const uid = userIdInput.value;

    const amount_signed = type === "Chi" ? -amount : amount;
    const d = new Date(date);
    const transaction_id = `${Date.now()}_${uid}`;

    const addField = (name, value) => {
      let input = transactionForm.querySelector(`input[name="${name}"]`);
      if (!input) {
        input = document.createElement("input"); input.type = "hidden"; input.name = name;
        transactionForm.appendChild(input);
      }
      input.value = value;
    };

    addField("transaction_id", transaction_id);
    addField("amount_signed", amount_signed);
    addField("year", d.getFullYear());
    addField("month", String(d.getMonth() + 1).padStart(2, '0'));

    setTimeout(() => {
      alert("âœ… ÄÃ£ lÆ°u giao dá»‹ch!");
      transactionForm.reset();
    }, 400);
  });

  window.logout = () => { import("../js/auth.js").then(m => m.logout()); };
</script>
</body>
</html>