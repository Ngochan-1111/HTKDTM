<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Finance BI - Home</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/analysis.css">
</head>

<body>

    <div class="container">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ’¼ Finance BI</h1>
                <p class="user-email">ğŸ‘¤ <span id="userEmail">TÃ i khoáº£n</span></p>
                <button onclick="logout()" class="btn-logout">ÄÄƒng xuáº¥t</button>
            </div>

            <nav class="sidebar-nav">
                <a href="index.html" class="nav-link">ğŸ  Trang chá»§</a>
                <a href="transactions.html" class="nav-link">ğŸ“Š Thu â€“ Chi</a>
                <a href="dashboard.html" class="nav-link">ğŸ“ˆ Dashboard</a>
                <a href="budget.html" class="nav-link">ğŸ’° NgÃ¢n sÃ¡ch</a>
                <a href="insight.html" class="nav-link">ğŸ” Insight</a>
                <a href="reminders.html" class="nav-link">ğŸ”” Nháº¯c nhá»Ÿ</a>
                <a href="analysis.html" class="nav-link active">ğŸ“– Analysis</a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main">

            <!-- hieu -->
            <div class="analysis-section">
                <h3>Lá»‹ch sá»­ chi tiÃªu</h3>
                <table id="summary-table" class="data-table"></table>

                <h3>Dá»± bÃ¡o thÃ¡ng tá»›i</h3>
                <table id="du-bao-table" class="data-table"></table>
            </div>

            <div class="analysis-section">
                <h3>Thay Ä‘á»•i % chi tiÃªu theo thÃ¡ng</h3>
                <table id="change-pct-table" class="data-table"></table>

                <h3>Xu hÆ°á»›ng tá»•ng thá»ƒ</h3>
                <table id="trends-table" class="data-table"></table>

                <h3>Biá»ƒu Ä‘á»“</h3>
                <a class="btn-das" href="dashboard.html" class="nav-link">ğŸ“ˆ Dashboard</a>
            </div>
            <!-- hieu -->

        </main>

    </div>
    <!-- hieu -->
    <script type="module">
        import { auth } from "../js/firebase.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const form = document.getElementById("transactionForm");
        const userEmailEl = document.getElementById("userEmail");
        const userIdInput = document.getElementById("user_id");

        // Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../login.html";
                return;
            }
            userEmailEl.textContent = user.email;
            userIdInput.value = user.uid; // GÃ¡n UID vÃ o hidden input
        });

        // hieu
        //-----------------------------------------------------------
        // Fetch vÃ  hiá»ƒn thá»‹ dá»¯ liá»‡u Summary_Chi
        function loadSummaryChi() {
            const apiUrl =
                "https://script.google.com/macros/s/AKfycbzCSgrYuVx-uo2f5ZewQJlIgJISNcVKFmbUgPLeBGK92HTu-u59brpZeKzVS7Vu2VfUgQ/exec?type=summary_chi";

            fetch(apiUrl)
                .then((res) => res.json())
                .then((data) => {
                    const table = document.getElementById("summary-table");
                    table.innerHTML = "";

                    data
                        // ğŸ‘‰ Lá»ŒC ROW Rá»–NG
                        .filter(
                            (row) =>
                                row &&
                                row.some(
                                    (cell) =>
                                        cell !== "" &&
                                        cell !== null &&
                                        cell !== undefined
                                )
                        )
                        .forEach((row, index) => {
                            const tr = document.createElement("tr");
                            row.forEach((cell) => {
                                const td = document.createElement(
                                    index === 0 ? "th" : "td"
                                );
                                td.textContent = cell;
                                tr.appendChild(td);
                            });
                            table.appendChild(tr);
                        });
                })
                .catch((err) =>
                    console.error("Lá»—i fetch Summary_Chi:", err)
                );
        }


        // Fetch vÃ  hiá»ƒn thá»‹ dá»¯ liá»‡u Du_Bao
        function loadDuBao() {
            const apiUrl =
                "https://script.google.com/macros/s/AKfycbzCSgrYuVx-uo2f5ZewQJlIgJISNcVKFmbUgPLeBGK92HTu-u59brpZeKzVS7Vu2VfUgQ/exec?type=du_bao";

            fetch(apiUrl)
                .then((res) => res.json())
                .then((data) => {
                    const table = document.getElementById("du-bao-table");
                    table.innerHTML = "";

                    data
                        .filter(
                            (row) =>
                                row &&
                                row.some(
                                    (cell) =>
                                        cell !== "" &&
                                        cell !== null &&
                                        cell !== undefined
                                )
                        )
                        .forEach((row, index) => {
                            const tr = document.createElement("tr");
                            row.forEach((cell) => {
                                const td = document.createElement(
                                    index === 0 ? "th" : "td"
                                );
                                td.textContent = cell;
                                tr.appendChild(td);
                            });
                            table.appendChild(tr);
                        });
                })
                .catch((err) =>
                    console.error("Lá»—i fetch Du_Bao:", err)
                );
        }

        // Load báº£ng thay Ä‘á»•i %
        function loadChangePct() {
            fetch("https://script.google.com/macros/s/AKfycbwz78_UNY6sIVMmvJuMJSVmEBeMEKBFpvJNb4Rut6aWjiiHw4w8c0NlkyMctzu7_4JYQw/exec?type=change_pct")
                .then(res => res.json())
                .then(data => {
                    const table = document.getElementById("change-pct-table");
                    table.innerHTML = "";

                    // Header
                    const trHeader = document.createElement("tr");
                    ["ThÃ¡ng", "Danh má»¥c", "Tá»•ng chi", "% Thay Ä‘á»•i"].forEach(h => {
                        const th = document.createElement("th");
                        th.textContent = h;
                        trHeader.appendChild(th);
                    });
                    table.appendChild(trHeader);

                    data.forEach(row => {
                        const tr = document.createElement("tr");

                        const period = String(row.period);
                        const periodText = `${period.slice(0, 4)}-${period.slice(4)}`;

                        tr.innerHTML = `
          <td>${periodText}</td>
          <td>${row.category_final}</td>
          <td>${row.Tong_Chi_Abs.toLocaleString("vi-VN")}</td>
          <td>${row.Change_Pct.toFixed(2)}%</td>
        `;
                        table.appendChild(tr);
                    });
                })
                .catch(err => console.error("change_pct lá»—i:", err));
        }

        function loadTrends() {
            fetch("https://script.google.com/macros/s/AKfycbwz78_UNY6sIVMmvJuMJSVmEBeMEKBFpvJNb4Rut6aWjiiHw4w8c0NlkyMctzu7_4JYQw/exec?type=trends")
                .then(res => res.json())
                .then(data => {
                    const table = document.getElementById("trends-table");
                    table.innerHTML = "";

                    const trHeader = document.createElement("tr");
                    ["Xu hÆ°á»›ng"].forEach(h => {
                        const th = document.createElement("th");
                        th.textContent = h;
                        trHeader.appendChild(th);
                    });
                    table.appendChild(trHeader);

                    data.forEach(row => {
                        const tr = document.createElement("tr");
                        const td = document.createElement("td");
                        td.textContent = row.trend;
                        tr.appendChild(td);
                        table.appendChild(tr);
                    });
                })
                .catch(err => console.error("trends lá»—i:", err));
        }

        // Load khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ... code cÅ© ...
                loadSummaryChi(); // Load tÃ­nh nÄƒng 1
                loadDuBao();
                loadChangePct(); // Load thay Ä‘á»•i %
                loadTrends();    // Load xu hÆ°á»›ng
            }
        });
        //-----------------------------------------------------------

        // Xá»­ lÃ½ logout (dÃ¹ng hÃ m trong auth.js)
        window.logout = () => {
            import("../js/auth.js").then((module) => {
                module.logout();
            });
        };

        // Can thiá»‡p trÆ°á»›c khi submit form
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(form);
            const date = formData.get("date"); // YYYY-MM-DD
            const amount = parseFloat(formData.get("amount")) || 0;
            const type = formData.get("type");
            const uid = userIdInput.value;

            if (!date || !uid) {
                alert("âŒ Vui lÃ²ng Ä‘Äƒng nháº­p vÃ  chá»n ngÃ y há»£p lá»‡.");
                return;
            }

            // TÃ­nh toÃ¡n cÃ¡c trÆ°á»ng bá»• sung
            const amount_signed = type === "Chi" ? -amount : amount;
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, "0");

            // Táº¡o transaction_id duy nháº¥t
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:T]/g, "").slice(0, 14); // vd: 20260113153022
            const random = Math.floor(Math.random() * 1000)
                .toString()
                .padStart(3, "0");
            const transaction_id = `${timestamp}_${uid}_${random}`;

            // ThÃªm cÃ¡c trÆ°á»ng áº©n vÃ o form
            const addField = (name, value) => {
                let input = form.querySelector(`input[name="${name}"]`);
                if (!input) {
                    input = document.createElement("input");
                    input.type = "hidden";
                    input.name = name;
                    form.appendChild(input);
                }
                input.value = value;
            };

            addField("transaction_id", transaction_id);
            addField("amount_signed", amount_signed);
            addField("year", year);
            addField("month", month);

            // Submit form
            form.submit();

            // ThÃ´ng bÃ¡o & reset
            setTimeout(() => {
                alert("âœ… ÄÃ£ lÆ°u giao dá»‹ch thÃ nh cÃ´ng!");
                form.reset();
                // XÃ³a cÃ¡c input áº©n
                ["transaction_id", "amount_signed", "year", "month"].forEach(
                    (name) => {
                        const el = form.querySelector(`input[name="${name}"]`);
                        if (el) el.remove();
                    }
                );
            }, 400);
        });
    </script>
<script src="../js/chatbot.js"></script>
</body>

</html>